name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Semver tag to release (e.g. v1.2.2)"
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            tag="${{ github.event.inputs.tag }}"
          else
            tag="${GITHUB_REF_NAME}"
          fi

          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$tag' must match vMAJOR.MINOR.PATCH" >&2
            exit 1
          fi

          version="${tag#v}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Validate tag exists in repository
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.meta.outputs.tag }}"
          git fetch --tags --force
          if ! git rev-parse --verify "refs/tags/$tag" >/dev/null 2>&1; then
            echo "Tag '$tag' does not exist in repository history" >&2
            exit 1
          fi
          git checkout "refs/tags/$tag"

      - name: Build release notes from changelog
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.meta.outputs.version }}"

          awk -v version="$version" '
            $0 ~ "^## \\[" version "\\]" {in_section=1; found=1; next}
            in_section && $0 ~ "^## \\[" {exit}
            in_section {print}
            END {
              if (!found) exit 2
            }
          ' CHANGELOG.md > release_notes.md || {
            code="$?"
            if [[ "$code" -eq 2 ]]; then
              echo "No CHANGELOG.md section found for version $version" >&2
            fi
            exit "$code"
          }

          if [[ ! -s release_notes.md ]]; then
            echo "Release notes section for $version is empty" >&2
            exit 1
          fi

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.meta.outputs.tag }}"
          title="Rustnake $tag"

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release edit "$tag" --title "$title" --notes-file release_notes.md
          else
            gh release create "$tag" --verify-tag --title "$title" --notes-file release_notes.md
          fi

  binaries:
    name: Build & Upload (${{ matrix.os }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          ref: refs/tags/${{ needs.prepare.outputs.tag }}

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal
          rustup default 1.93.0

      - name: Build release binary
        run: cargo build --release --locked

      - name: Package asset
        id: package
        shell: bash
        run: |
          set -euo pipefail
          source="target/release/rustnake"
          asset_name="rustnake-linux-x86_64"
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            source="target/release/rustnake.exe"
            asset_name="rustnake-windows-x86_64.exe"
          elif [[ "${RUNNER_OS}" == "macOS" ]]; then
            arch="$(uname -m)"
            if [[ "$arch" == "arm64" ]]; then
              asset_name="rustnake-macos-arm64"
            else
              asset_name="rustnake-macos-x86_64"
            fi
          fi

          if [[ ! -f "$source" ]]; then
            echo "Missing build artifact: $source" >&2
            exit 1
          fi
          asset_path="$RUNNER_TEMP/$asset_name"
          cp "$source" "$asset_path"
          echo "asset_name=$asset_name" >> "$GITHUB_OUTPUT"
          echo "asset_path=$asset_path" >> "$GITHUB_OUTPUT"

      - name: Upload asset to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${{ needs.prepare.outputs.tag }}" \
            "${{ steps.package.outputs.asset_path }}#${{ steps.package.outputs.asset_name }}" \
            --clobber
