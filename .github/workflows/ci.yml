name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow_lint:
    name: Workflow Lint (actionlint)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install actionlint
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v go >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y golang-go
          fi
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.8

      - name: Run actionlint
        shell: bash
        run: |
          set -euo pipefail
          "$(go env GOPATH)/bin/actionlint" -color

  verify:
    name: Verify (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal
          rustup default 1.93.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo check
        run: cargo check --all-targets --all-features --locked

      - name: cargo test
        run: cargo test --all-targets --all-features --locked

  lint:
    name: Lint (Pinned Toolchain)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal --component rustfmt --component clippy
          rustup default 1.93.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --all-targets --all-features --locked -- -D warnings

  msrv:
    name: Verify (MSRV 1.85)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install MSRV toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.85.0 --profile minimal
          rustup default 1.85.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo check (msrv)
        run: cargo check --all-targets --all-features --locked

      - name: cargo test (msrv)
        run: cargo test --all-targets --all-features --locked

  supply_chain:
    name: Supply-Chain (Audit + License)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          fetch-depth: 0

      - name: Detect dependency/security-related changes
        id: sc_changes
        shell: bash
        run: |
          set -euo pipefail

          should_run="true"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
            range="${base}...${head}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [[ "$base" == "0000000000000000000000000000000000000000" ]]; then
              range=""
            else
              range="${base}...${head}"
            fi
          else
            range=""
          fi

          if [[ -n "$range" ]]; then
            changed="$(git diff --name-only "$range" || true)"
            echo "$changed"
            if ! echo "$changed" | grep -Eq '(^|/)(Cargo\.toml|Cargo\.lock|deny\.toml)$|^\.github/workflows/(ci|release)\.yml$'; then
              should_run="false"
            fi
          fi

          echo "run=$should_run" >> "$GITHUB_OUTPUT"

      - name: Skip supply-chain check (no relevant changes)
        if: ${{ steps.sc_changes.outputs.run != 'true' }}
        run: echo "No dependency/security workflow changes detected; skipping cargo-deny."

      - name: Install pinned Rust toolchain
        if: ${{ steps.sc_changes.outputs.run == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal
          rustup default 1.93.0

      - name: cargo fetch
        if: ${{ steps.sc_changes.outputs.run == 'true' }}
        run: cargo fetch --locked

      - name: Install cargo-deny (prebuilt, fallback to source)
        if: ${{ steps.sc_changes.outputs.run == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          CARGO_DENY_VERSION="0.19.0"
          TARGET="x86_64-unknown-linux-musl"
          ARCHIVE="cargo-deny-${CARGO_DENY_VERSION}-${TARGET}.tar.gz"
          URL="https://github.com/EmbarkStudios/cargo-deny/releases/download/${CARGO_DENY_VERSION}/${ARCHIVE}"
          TMP_DIR="$(mktemp -d)"

          install_prebuilt() {
            curl -fsSL "$URL" -o "$TMP_DIR/$ARCHIVE"
            tar -xzf "$TMP_DIR/$ARCHIVE" --strip-components=1 -C "$TMP_DIR"
            install -m 755 "$TMP_DIR/cargo-deny" "$HOME/.cargo/bin/cargo-deny"
          }

          if install_prebuilt; then
            cargo-deny --version
          else
            echo "Prebuilt cargo-deny download failed; falling back to cargo install." >&2
            cargo install cargo-deny --locked
          fi

      - name: cargo deny
        if: ${{ steps.sc_changes.outputs.run == 'true' }}
        run: cargo deny check advisories licenses bans sources
