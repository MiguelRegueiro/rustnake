name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    name: Verify (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal
          rustup default 1.93.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo check
        run: cargo check --all-targets --all-features --locked

      - name: cargo test
        run: cargo test --all-targets --all-features --locked

  lint:
    name: Lint (Pinned Toolchain)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal --component rustfmt --component clippy
          rustup default 1.93.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --all-targets --all-features --locked -- -D warnings

  msrv:
    name: Verify (MSRV 1.85)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install MSRV toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.85.0 --profile minimal
          rustup default 1.85.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: cargo check (msrv)
        run: cargo check --all-targets --all-features --locked

      - name: cargo test (msrv)
        run: cargo test --all-targets --all-features --locked

  supply_chain:
    name: Supply-Chain (Audit + License)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install pinned Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.0 --profile minimal
          rustup default 1.93.0

      - name: cargo fetch
        run: cargo fetch --locked

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: cargo deny
        run: cargo deny check advisories licenses bans sources
